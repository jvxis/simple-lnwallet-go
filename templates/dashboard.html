{{ define "content" }}
<h2>âš¡ Node Status</h2>
<pre>
ğŸ·ï¸ Alias do Node:    <strong>{{ .NodeInfo.Alias }}</strong>
ğŸ§© VersÃ£o do LND:    {{ .NodeInfo.Version }}
ğŸ”— NÃºmero de Canais: {{ add .NodeInfo.NumActiveChannels .NodeInfo.NumInactiveChannels }}
â›” Canais Inativos:  {{ if gt .NodeInfo.NumInactiveChannels 0 }}<span class="neon-red">{{ .NodeInfo.NumInactiveChannels }}</span>{{ else }}{{ .NodeInfo.NumInactiveChannels }}{{ end }}

â›“ï¸ Sincronizado com Blockchain:     {{ if .NodeInfo.SyncedToChain }}âœ…{{ else }}âŒ{{ end }}
ğŸŒ Sincronizado com Rede Lightning: {{ if .NodeInfo.SyncedToGraph }}âœ…{{ else }}âŒ{{ end }}
</pre>

<h2>ğŸ’° Saldo</h2>
<pre>
- ğŸ”— Saldo Onchain:   {{ formatSat .Balance.ConfirmedBalance }} sats ({{ toBTC .Balance.ConfirmedBalance }} BTC)
- âš¡ Saldo Lightning: {{ formatSat .ChannelBalance }} sats ({{ toBTC .ChannelBalance }} BTC)
</pre>

<div class="menu">
    <a href="/invoice">ğŸ§¾ Criar Fatura</a>
    <a href="/pay">ğŸ’¸ Pagar Fatura</a>
    <a href="/channels">ğŸ”€ Canais</a>
    <a href="#" id="openChannelBtn">â• Abrir Canal</a>
    <a href="/">â†©ï¸ Voltar Ã  ConexÃ£o</a>
 </div>

<!-- Modal Abrir Canal -->
<div id="openChannelModal" class="modal-overlay">
  <div class="modal-content">
    <h3>â• Abrir Canal</h3>
    <div id="openChannelMessage" class="modal-message" style="display:none;"></div>
    <form id="openChannelForm">
        <label>ğŸ¤ Peer (pubkey@host:port):</label>
        <input type="text" name="peer_info" placeholder="0289...@1.2.3.4:9735" required>

        <label>ğŸ’° Valor (sats):</label>
        <input type="number" name="amount_sats" min="1" placeholder="Ex: 250000" required>

        <label>â›½ Taxa (sat/vByte):</label>
        <input type="number" name="sat_per_vbyte" min="1" placeholder="Ex: 3" required>

        <label>ğŸ EndereÃ§o on-chain de fechamento (opcional):</label>
        <input type="text" name="close_address" placeholder="bc1...">

        <div class="modal-actions">
            <button type="submit" id="confirmOpenChannel">ğŸ¤ Conectar e Abrir</button>
            <button type="button" id="cancelOpenChannel">âœ–ï¸ Cancelar</button>
        </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('openChannelModal');
    const btn = document.getElementById('openChannelBtn');
    const form = document.getElementById('openChannelForm');
    const cancelBtn = document.getElementById('cancelOpenChannel');
    const confirmBtn = document.getElementById('confirmOpenChannel');
    const msg = document.getElementById('openChannelMessage');

    if (btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        msg.style.display = 'none';
        msg.textContent = '';
        modal.classList.add('is-visible');
      });
    }
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        modal.classList.remove('is-visible');
        form.reset();
        document.body.style.cursor = 'default';
      });
    }
    // Fechar se clicar fora do conteÃºdo
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.classList.remove('is-visible');
        document.body.style.cursor = 'default';
      }
    });

    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        // ValidaÃ§Ãµes simples de front-end
        const fd = new FormData(form);
        const peer = String(fd.get('peer_info')||'').trim();
        const amount = parseInt(String(fd.get('amount_sats')||'0'), 10);
        const satvb = parseInt(String(fd.get('sat_per_vbyte')||'0'), 10);
        msg.classList.remove('error','success');
        if (!peer.includes('@') || !peer.split('@')[1]?.includes(':')) {
          msg.style.display = 'block';
          msg.classList.add('error');
          msg.textContent = 'âŒ Formato do peer invÃ¡lido. Use pubkey@host:port';
          return;
        }
        const MIN_SATS = 200000; // mÃ­nimo recomendado para canais
        if (!(amount > 0)) {
          msg.style.display = 'block';
          msg.classList.add('error');
          msg.textContent = 'âŒ Informe um valor de canal em satoshis (> 0).';
          return;
        }
        if (amount < MIN_SATS) {
          msg.style.display = 'block';
          msg.classList.add('error');
          msg.textContent = 'âš ï¸ Valor muito baixo. Recomenda-se >= 200000 sats para melhor roteamento.';
          return;
        }
        if (!(satvb >= 1)) {
          msg.style.display = 'block';
          msg.classList.add('error');
          msg.textContent = 'âŒ Taxa invÃ¡lida. Use sat/vByte >= 1.';
          return;
        }

        msg.style.display = 'block';
        msg.textContent = 'â³ Processando...';
        document.body.style.cursor = 'wait';
        confirmBtn.disabled = true;
        try {
          const body = new URLSearchParams(fd);
          const res = await fetch('/channels/open', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
          });
          const data = await res.json();
          if (data.status === 'ok') {
            msg.classList.add('success');
            msg.innerHTML = 'âœ… Canal aberto! TXID: ' + data.funding_txid + ' (vout ' + data.output_index + '). ' +
              '<a href="/channels">ğŸ” Ver canais</a>';
          } else {
            msg.classList.add('error');
            msg.textContent = 'âŒ Erro: ' + (data.message || 'Falha ao abrir canal');
          }
        } catch (err) {
          console.error(err);
          msg.classList.add('error');
          msg.textContent = 'âš ï¸ Erro inesperado: ' + err;
        } finally {
          document.body.style.cursor = 'default';
          confirmBtn.disabled = false;
        }
      });
    }
  })();
</script>
{{ end }}

